"use strict";angular.module("ngGather",["pascalprecht.translate","ui.router","ui.bootstrap","ngResource","angular-loading-bar","ngAnimate","pc035860.scrollWatch","ngAside"]).config(["$locationProvider","$translateProvider",function(e,t){t.useStaticFilesLoader({prefix:"languages/",suffix:".json"}),t.preferredLanguage("zh-hans"),e.html5Mode(!1)}]),angular.module("ngGather").filter("updateTimeFilter",["$filter",function(e){return function(t){return t?e("date")(t,"yy-MM-dd HH:mm"):"未知时间"}}]),angular.module("ngGather").filter("imgUrlChange",["SERVERURL",function(e){return function(t){return t&&/zdfans|waitsun|iqshw/i.test(t)?e+"/api/v1/getImg?imgurl="+encodeURIComponent(t):t}}]),angular.module("ngGather").service("errorHandlingService",["$state","$translate","notificationService",function(e,t,n){var i=this;this.handleError=function(e){if(_.isObject(e)){if(e.data&&e.data.err)return n.error(t.instant("error."+e.data.err));if(e.status){var i="httpStatusMessage."+e.status,a=t.instant(i);return i===a&&(i="httpStatusMessage.0",a=t.instant(i)),n.error(a)}}_.isString(e)&&n.error(t.instant(e))},this.handleHttpError=function(e,t){i.handleError({status:t,data:e})}}]),angular.module("ngGather").constant("SERVERURL","http://nggather.coding.io").constant("ALL_SITES",[{name:"ZD423",ischecked:!0,description:"专注绿软，分享软件、传递最新软件资讯",url:"http://www.zdfans.com/",site:"zd",classify:"windows"},{name:"llm",ischecked:!0,description:"浏览迷(原浏览器之家)是一个关注浏览器及软件、IT的科技博客,致力于为广大浏览器爱好者提供一个关注浏览器、交流浏览器、折腾浏览器的专门网站",url:"http://liulanmi.com/",site:"llm",classify:"info"},{name:"爱Q生活网",ischecked:!0,description:"爱Q生活网 - 亮亮'blog -关注最新QQ活动动态, 掌握QQ第一资讯",url:"http://www.iqshw.com/",site:"iqq",classify:"info"},{name:"waitsun",ischecked:!0,chName:"爱情守望者",description:"爱情守望者博客以分享，互助和交流为宗旨，分享软件，电影，资源，设计和网络免费资源。",url:"http://www.waitsun.com/",site:"waitsun",classify:"mac"},{name:"MacPeers",ischecked:!0,url:"http://www.macpeers.com/",description:"最有价值的mac软件免费分享源，提供最新mac破解软件免费下载。",site:"MacPeers",classify:"mac"}]).constant("dataChooses",[{value:1,str:"1天内"},{value:2,str:"2天内"},{value:3,str:"3天内"},{value:5,str:"5天内"}]),angular.module("ngGather").service("localSaveService",function(){this.get=function(){try{var e=JSON.parse(localStorage.getItem("shang_ngGather"))||{};return{sites:e.sites,themeType:e.themeType}}catch(t){return localStorage.removeItem("shang_ngGather"),null}},this.set=function(e,t){localStorage.setItem("shang_ngGather",JSON.stringify({sites:e,themeType:t}))}}),angular.module("ngGather").factory("sitesInfoEntity",["$resource","SERVERURL",function(e,t){return e(t+"/api/v1/sites",{},{update:{method:"PUT"}})}]).factory("updateTimeEntity",["$resource","SERVERURL",function(e,t){return e(t+"/api/v1/updateTime",{},{update:{method:"PUT"}})}]).factory("allSitesEntity",["$resource","SERVERURL",function(e,t){return e(t+"/api/v1/allSites",{},{update:{method:"PUT"}})}]),angular.module("ngGather").config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("","/contents"),t.otherwise("/contents"),e.state("home",{url:"",templateUrl:"templates/home.html",controller:"chooseCtrl"}).state("home.contents",{url:"/contents",controller:"contentsCtrl"})}]),angular.module("ngGather").controller("chooseCtrl",["$scope","$timeout","$aside","themeSwitcherService","toastService","notificationService","errorHandlingService","localSaveService","sitesInfoEntity","updateTimeEntity","allSitesEntity","ALL_SITES",function(e,t,n,i,a,o,s,r,c,l,h,d){function u(){_.forEach(E.chooseSite,function(t){t.ischecked&&e.sites.push(t.site)}),e.themeType&&(e.themeType=!1,e.changeTheme()),m(),e.$on("load more",function(t,n,i){i.$percentage>90&&e.addMore()}),h.get().$promise.then(function(e){e=e.allSites||[],e.forEach(function(e){var t=_.findIndex(E.chooseSite,function(t){return t.site===e.site});(E.chooseSite[t]||{}).latesGatherTime=e.latesGatherTime})})["catch"](function(e){})}function m(){l.get().$promise.then(function(t){e.updateTime=t.updateTime})["catch"](function(e){s.handleError(e)})}function f(){return h.get().$promise.then(function(e){e=e.allSites||[],e.forEach(function(e){var t=_.findIndex(E.chooseSite,function(t){return t.site===e.site});(E.chooseSite[t]||{}).latesGatherTime=e.latesGatherTime})})["catch"](function(e){})}function g(){e.ishow=!e.ishow,e.ishow&&f().then(function(){E.showSites=angular.copy(E.chooseSite)})}function p(t){if(e.ishow=!e.ishow,t)return void(E.showSites=E.chooseSite);var n=[];E.chooseSite=E.showSites,_.forEach(E.chooseSite,function(e){e.ischecked&&n.push(e.site)}),e.sites=n,e.getData(),r.set(E.chooseSite,e.themeType)}function v(){e.canForceUpdte=!1,t(function(){e.canForceUpdte=!0},12e4),o.info("强制重新采集中~~请稍后刷新~",3500),c.get({force:1}).$promise.then(function(){})["catch"](function(e){s.handleError(e)})}function S(){e.pageNu=0,e.addMore(!0),m()}function b(t){e.isSearch=!0,(t||!e.keyword)&&(e.isSearch=!1,e.keyword=""),e.pageNu=0,e.addMore(!0)}function y(n){if(0===e.addMoreState||n){t.cancel($),$=t(function(){e.addMoreState=0},15e3),e.addMoreState=2;var i={pageNu:e.pageNu||0,updateTime:e.updateTime?new Date(e.updateTime).getTime():(new Date).getTime()};e.sites&&_.isArray(e.sites)&&(i.sites=e.sites),n&&(i.times=(new Date).getTime()),e.isSearch&&(i.keyword=e.keyword),c.query(i).$promise.then(function(t){e.addMoreState=0,e.pageNu=(e.pageNu||0)+1,n?e.contents=t:e.contents=e.contents.concat(t),t&&t.length||(e.addMoreState=1)})["catch"](function(t){e.addMoreState=0,s.handleError(t)})}}function w(){M&&M.length||(M.push({href:"css/night/night-bb07298e58.min.css",disabled:!0}),i.replaceThemes(M)),M.forEach(function(e){e.disabled=!e.disabled}),e.themeType=!e.themeType,r.set(E.chooseSite,e.themeType)}function T(e,t){f().then(function(){E.showSites=angular.copy(E.chooseSite),n.open({templateUrl:"templates/choose-site.html",placement:e,size:"lg",backdrop:t,controller:["$scope","$uibModalInstance",function(e,t){e.chooseSite=E.chooseSite,e.showSites=E.showSites,e.ok=function(e){t.close(),e.stopPropagation()},e.cancel=function(e){t.dismiss(),e.stopPropagation()}}]}).result.then(function(){p()},function(){p(!0)})})}var k=r.get(),E={};e.ngModel=E,E.chooseSite=k.sites||d,e.themeType=!!k.themeType,e.addMoreState=0,e.canForceUpdte=!0,e.contents=[],e.isSearch=!1,e.ishide=!0,e.ishow=!1,e.keyword="",e.pageNu=0,e.sites=[],e.updateTime=0;var $=null,M=[];return e.addMore=y,e.changeSites=g,e.changeTheme=w,e.forceUpdate=v,e.getData=S,e.saveSites=p,e.search=b,e.openAside=T,u()}]),angular.module("ngGather").service("toastService",["$timeout",function(e){var t=[];this.setToast=function(n,i){t.length=0,t.push(n),e(function(){t.length=0},i||1500)},this.clearToast=function(){t.length=0},this.getToast=function(){return t}}]),angular.module("ngGather").directive("toast",function(){return{restrict:"AE",template:'<div class="toast" ng-show="toast && toast.length"><span class="msg">{{toast[0]}}</span></div>',replace:!0,scope:!0,controller:["$scope","toastService",function(e,t){e.toast=t.getToast()}]}}),angular.module("ngGather").service("themeSwitcherService",function(){var e=[],t=this;this.getThemes=function(){return e},this.addThemes=function(t){_.isArray(t)?e.push.apply(e,t):e.push(t)},this.removeTheme=function(t){e.splice(e.indexOf(t),1)},this.clearThemes=function(){e.length=0},this.replaceThemes=function(e){t.clearThemes(),t.addThemes(e)}}),angular.module("ngGather").directive("themeSwitcher",function(){return{restrict:"AE",template:'<link rel="stylesheet" ng-repeat="style in styles" ng-href="{{ style.href || style }}" ng-disabled="!!style.disabled"/>',replace:!0,scope:!0,controller:["$scope","themeSwitcherService",function(e,t){e.styles=t.getThemes()}]}}),angular.module("ngGather").service("notificationService",["$timeout",function(e){var t=[],n=this;this.getNotifications=function(){return t},this.removeNotification=function(e){t.splice(t.indexOf(e),1)},this.error=function(i,a){var o={type:"error",message:i};t.push(o),e(function(){n.removeNotification(o)},a||5e3)},this.warn=function(i,a){var o={type:"warn",message:i};t.push(o),e(function(){n.removeNotification(o)},a||3e3)},this.info=function(i,a){var o={type:"info",message:i};t.push(o),e(function(){n.removeNotification(o)},a||2e3)}}]),angular.module("ngGather").directive("notificationBar",function(){return{restrict:"AE",templateUrl:"components/notification/notification-bar.tpl.html",controller:["$scope","notificationService",function(e,t){e.notifications=t.getNotifications(),e.types={error:"danger",warn:"warning",info:"info"},e.close=function(t){e.notifications.splice(t,1)}}]}}),angular.module("ngGather").run(["$templateCache",function(e){e.put("templates/choose-site.html",'<div class="modal-body choose-site"><table class="table table-bordered table-striped"><tr ng-repeat="choose in (showSites || chooseSite)"><td><div class="checkbox"><label><input type="checkbox" ng-model="choose.ischecked">{{choose.name}}</label></div></td><td><a href="{{choose.url}}" target="_blank">{{choose.description}}</a></td><td><span>{{choose.latesGatherTime | updateTimeFilter}}</span></td></tr><tr><td></td><td><button class="btn btn-primary" ng-click="ok($event)">保存</button> <button class="btn btn-warning" ng-click="cancel($event)">取消</button></td><td></td></tr></table></div>'),e.put("templates/home.html",'<div><nav class="navbar navbar-default"><div class="navbar-header"><a class="navbar-brand text-center btn-link more-option" ng-click="ishide = !ishide">ngGather</a></div><ul class="nav navbar-nav navbar-left" ng-class="{\'mobile-hide\': ishide}"><li><a class="btn btn-link" ng-click="openAside(\'left\', true)">站点选择</a></li><li ng-class="{\'mobile-hide\': ishide}"><form class="navbar-form navbar-left search" role="search" ng-submit="search()"><div class="form-group"><input type="text" class="form-control" placeholder="回车搜索" ng-model="keyword"></div></form></li><li ng-show="!!keyword"><a class="btn btn-link" ng-click="search(true)">取消搜索</a></li></ul><ul class="nav navbar-nav navbar-right"><li ng-class="{\'mobile-hide\': ishide}"><a class="btn btn-link" ng-click="addMoreState !== 0 || getData()" ng-disabled="addMoreState !== 0">重新获取</a></li><li ng-class="{\'mobile-hide\': ishide}"><a class="btn btn-link" ng-click="changeTheme()">{{themeType ? \'换白色主题\' : \'换黑色主题\'}}</a></li><li><a class="btn btn-link" ng-click="!canForceUpdte || forceUpdate()" ng-disabled="!canForceUpdte">更新时间: {{updateTime | updateTimeFilter}}</a></li></ul></nav></div><div scroll-watch="{from: 0, to: -1}" sw-broadcast="{\'load more\': \'$percentage > 90\'}"><div class="row" ng-repeat="content in contents"><div class="contents"><div class="col-xs-12 col-sm-3 text-center"><a ng-href="{{content.href}}" target="_blank"><img ng-src="{{content.img | imgUrlChange}}"></a></div><div class="col-xs-12 col-sm-9"><div class="col-xs-12 col-sm-10"><a ng-href="{{content.href}}" target="_blank"><div class="title">[{{content.site}}] {{content.title}}</div></a></div><div class="col-xs-12 col-sm-2 detail">{{content.gatherTime | date:"yy/MM/dd HH:mm"}}</div><div class="col-xs-12 col-sm-12">{{content.intro}}</div></div><div class="col-xs-12 col-sm-12"><hr></div></div></div><div class="addmore text-center"><a class="btn btn-primary" ng-click="addMoreState !== 0 || addMore()" ng-disabled="addMoreState !== 0">{{[\'加载更多~\', \'没有更多了~~\', \'加载中~~\'][addMoreState]}}</a></div></div>'),e.put("components/notification/notification-bar.tpl.html",'<alert class="center-block col-sm-6" ng-repeat="notification in notifications" type="{{types[notification.type]}}" close="close($index)">{{notification.message}}</alert>')}]);